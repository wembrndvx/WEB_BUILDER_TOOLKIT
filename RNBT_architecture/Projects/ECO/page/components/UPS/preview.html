<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS - Preview (Metric API 연동)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1219;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .preview-controls { display: flex; gap: 12px; }

        .preview-btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .preview-btn:hover { background: #2563eb; }
        .preview-btn.warning { background: #eab308; color: #000; }
        .preview-btn.critical { background: #ef4444; }
        .preview-btn.destroy { background: #6b7280; }
        .preview-btn.destroy:hover { background: #4b5563; }

        .instance-info { font-size: 12px; color: #6b7280; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="preview-controls">
        <button class="preview-btn" onclick="showNormal()">Normal UPS</button>
        <button class="preview-btn warning" onclick="showWarning()">Warning UPS</button>
        <button class="preview-btn critical" onclick="showCritical()">Critical UPS</button>
        <button class="preview-btn destroy" onclick="destroyInstance()">Destroy</button>
    </div>
    <div class="instance-info" id="instance-info">Instance: not created</div>

    <div id="popup-host"></div>

    <script>
        // ======================
        // TEMPLATE DATA (새로운 섹션 구조)
        // ======================
        const htmlCode = `
            <template id="popup-ups">
                <div class="popup-overlay">
                    <div class="popup-content">
                        <div class="popup-header">
                            <div class="header-info">
                                <h2 class="ups-name">-</h2>
                                <span class="ups-zone">-</span>
                            </div>
                            <div class="header-actions">
                                <span class="ups-status" data-status="normal">Normal</span>
                                <button class="close-btn" type="button" aria-label="Close">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="popup-body">
                            <div class="section metrics-section">
                                <div class="section-header">
                                    <span class="section-title"></span>
                                    <span class="section-timestamp"></span>
                                </div>
                                <div class="metrics-container"></div>
                            </div>
                            <div class="section properties-section">
                                <div class="section-header">
                                    <span class="section-title"></span>
                                </div>
                                <div class="properties-container"></div>
                            </div>
                            <div class="section chart-section">
                                <div class="section-header">
                                    <span class="section-title"></span>
                                </div>
                                <div class="chart-container">
                                    <div class="empty-state">히스토리 데이터가 없습니다</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        `;

        const cssCode = `
            .popup-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
            .popup-content { background: #1a1f2e; border-radius: 12px; width: 560px; max-width: 90vw; height: 90vh; overflow: hidden; box-shadow: 0 24px 48px rgba(0,0,0,0.4); border: 1px solid #2a3142; display: flex; flex-direction: column; }
            .popup-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #2a3142; flex-shrink: 0; }
            .header-info { display: flex; flex-direction: column; gap: 4px; }
            .ups-name { margin: 0; font-size: 18px; font-weight: 600; color: #e0e6ed; }
            .ups-zone { font-size: 13px; color: #8892a0; }
            .header-actions { display: flex; align-items: center; gap: 12px; }
            .ups-status { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; text-transform: capitalize; }
            .ups-status[data-status="normal"] { background: rgba(34,197,94,0.15); color: #22c55e; }
            .ups-status[data-status="warning"] { background: rgba(234,179,8,0.15); color: #eab308; }
            .ups-status[data-status="critical"] { background: rgba(239,68,68,0.15); color: #ef4444; }
            .close-btn { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; padding: 0; background: transparent; border: none; border-radius: 6px; color: #8892a0; cursor: pointer; transition: background 0.15s, color 0.15s; }
            .close-btn:hover { background: #2a3142; color: #e0e6ed; }
            .popup-body { padding: 24px; display: flex; flex-direction: column; gap: 20px; flex: 1; min-height: 0; overflow: hidden; }
            .section { background: #252b3b; border-radius: 8px; overflow: hidden; flex: 1; min-height: 0; display: flex; flex-direction: column; }
            .section-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #2a3142; flex-shrink: 0; }
            .section-title { font-size: 13px; font-weight: 500; color: #8892a0; text-transform: uppercase; letter-spacing: 0.5px; }
            .section-timestamp { font-size: 11px; color: #6b7280; }
            .metrics-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: #2a3142; flex: 1; overflow-y: auto; }
            .metric-card { background: #252b3b; padding: 16px 12px; text-align: center; }
            .metric-label { font-size: 10px; color: #8892a0; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
            .metric-value { font-size: 24px; font-weight: 600; color: #e0e6ed; line-height: 1; }
            .metric-unit { font-size: 12px; font-weight: 400; color: #8892a0; margin-left: 2px; }
            .metric-bool { padding: 12px; }
            .metric-value-bool { font-size: 16px; font-weight: 700; letter-spacing: 1px; }
            .metric-bool.bool-on .metric-value-bool { color: #22c55e; }
            .metric-bool.bool-off .metric-value-bool { color: #6b7280; }
            .metric-card[data-status="normal"] .metric-value { color: #22c55e; }
            .metric-card[data-status="warning"] .metric-value { color: #eab308; }
            .metric-card[data-status="critical"] .metric-value { color: #ef4444; }
            .properties-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: #2a3142; flex: 1; overflow-y: auto; }
            .property-card { background: #252b3b; padding: 12px 16px; }
            .property-label { font-size: 11px; color: #8892a0; margin-bottom: 4px; }
            .property-value { font-size: 14px; font-weight: 500; color: #e0e6ed; }
            .chart-section .chart-container { width: 100%; flex: 1; min-height: 180px; }
            .chart-section.hidden { display: none; }
            .empty-state { padding: 24px 16px; text-align: center; color: #6b7280; font-size: 13px; }
            .error-state { padding: 24px 16px; text-align: center; color: #ef4444; font-size: 13px; }
        `;

        // ======================
        // METRIC CONFIG (25 metrics from register.js)
        // ======================
        const METRIC_CONFIG = {
            'UPS.INPUT_V_1': { label: '입력전압 R', valueType: 'NUMBER', unit: 'V', scale: 0.1 },
            'UPS.INPUT_V_2': { label: '입력전압 S', valueType: 'NUMBER', unit: 'V', scale: 0.1 },
            'UPS.INPUT_V_3': { label: '입력전압 T', valueType: 'NUMBER', unit: 'V', scale: 0.1 },
            'UPS.INPUT_F_1': { label: '입력주파수 R', valueType: 'NUMBER', unit: 'Hz', scale: 0.1 },
            'UPS.INPUT_F_2': { label: '입력주파수 S', valueType: 'NUMBER', unit: 'Hz', scale: 0.1 },
            'UPS.INPUT_F_3': { label: '입력주파수 T', valueType: 'NUMBER', unit: 'Hz', scale: 0.1 },
            'UPS.INPUT_A_1': { label: '입력전류 R', valueType: 'NUMBER', unit: 'A', scale: 0.1 },
            'UPS.INPUT_A_2': { label: '입력전류 S', valueType: 'NUMBER', unit: 'A', scale: 0.1 },
            'UPS.INPUT_A_3': { label: '입력전류 T', valueType: 'NUMBER', unit: 'A', scale: 0.1 },
            'UPS.OUTPUT_V_1': { label: '출력전압 R', valueType: 'NUMBER', unit: 'V', scale: 0.1 },
            'UPS.OUTPUT_V_2': { label: '출력전압 S', valueType: 'NUMBER', unit: 'V', scale: 0.1 },
            'UPS.OUTPUT_V_3': { label: '출력전압 T', valueType: 'NUMBER', unit: 'V', scale: 0.1 },
            'UPS.OUTPUT_F_1': { label: '출력주파수 R', valueType: 'NUMBER', unit: 'Hz', scale: 0.1 },
            'UPS.OUTPUT_F_2': { label: '출력주파수 S', valueType: 'NUMBER', unit: 'Hz', scale: 0.1 },
            'UPS.OUTPUT_F_3': { label: '출력주파수 T', valueType: 'NUMBER', unit: 'Hz', scale: 0.1 },
            'UPS.OUTPUT_A_1': { label: '출력전류 R', valueType: 'NUMBER', unit: 'A', scale: 0.1 },
            'UPS.OUTPUT_A_2': { label: '출력전류 S', valueType: 'NUMBER', unit: 'A', scale: 0.1 },
            'UPS.OUTPUT_A_3': { label: '출력전류 T', valueType: 'NUMBER', unit: 'A', scale: 0.1 },
            'UPS.BATT_V': { label: '배터리전압', valueType: 'NUMBER', unit: 'V', scale: 0.1 },
            'UPS.BATT_A': { label: '배터리전류', valueType: 'NUMBER', unit: 'A', scale: 0.1 },
            'UPS.INPUT_BAD_STATE': { label: '입력전력이상', valueType: 'BOOL', unit: '', scale: 1.0 },
            'UPS.BATT_CHARGING': { label: '배터리충전중', valueType: 'BOOL', unit: '', scale: 1.0 },
            'UPS.OUTPUT_ON_BATTERY': { label: '배터리출력중', valueType: 'BOOL', unit: '', scale: 1.0 },
            'UPS.INVERTER_OFF': { label: '인버터정지', valueType: 'BOOL', unit: '', scale: 1.0 },
            'UPS.ON_BYPASS': { label: '바이패스운전', valueType: 'BOOL', unit: '', scale: 1.0 },
            'UPS.BATT_FAULT': { label: '배터리Fault', valueType: 'BOOL', unit: '', scale: 1.0 },
            'UPS.OUTPUT_OVERLOAD': { label: '출력과부하', valueType: 'BOOL', unit: '', scale: 1.0 },
        };

        // ======================
        // MOCK IMPLEMENTATIONS
        // ======================

        const fx = {
            go: (data, ...fns) => fns.reduce((acc, fn) => acc.then ? acc.then(fn) : Promise.resolve(fn(acc)), Promise.resolve(data)),
            each: (fn, arr) => {
                if (arr === undefined) return (arr2) => { arr2.forEach(fn); return arr2; };
                arr.forEach(fn); return arr;
            }
        };

        const Wkit = {
            bind3DEvents: (ctx, events) => console.log('[Wkit.bind3DEvents]', Object.keys(events)),
            fetchData: (page, datasetName, param) => {
                console.log('[Wkit.fetchData]', datasetName, param);
                return Promise.resolve({ response: { data: getMockData(datasetName) } });
            }
        };

        // Mock data
        let currentStatus = 'normal';

        // assetDetailUnified 응답
        const mockUPSData = {
            normal: {
                asset: { name: 'UPS-A01', locationLabel: 'Zone-A', statusType: 'ACTIVE' },
                properties: [
                    { label: '용량', value: '100kVA', helpText: 'UPS 정격 용량', displayOrder: 1 },
                    { label: '모델', value: 'GE LP33', helpText: 'UPS 모델명', displayOrder: 2 },
                    { label: '설치일', value: '2023-03-15', helpText: '설치 날짜', displayOrder: 3 },
                    { label: '운전모드', value: 'Online', helpText: '현재 운전 모드', displayOrder: 4 }
                ]
            },
            warning: {
                asset: { name: 'UPS-B02', locationLabel: 'Zone-B', statusType: 'WARNING' },
                properties: [
                    { label: '용량', value: '80kVA', helpText: 'UPS 정격 용량', displayOrder: 1 },
                    { label: '모델', value: 'Eaton 9PX', helpText: 'UPS 모델명', displayOrder: 2 },
                    { label: '설치일', value: '2022-08-10', helpText: '설치 날짜', displayOrder: 3 },
                    { label: '운전모드', value: 'Online', helpText: '현재 운전 모드', displayOrder: 4 }
                ]
            },
            critical: {
                asset: { name: 'UPS-C03', locationLabel: 'Zone-C', statusType: 'CRITICAL' },
                properties: [
                    { label: '용량', value: '60kVA', helpText: 'UPS 정격 용량', displayOrder: 1 },
                    { label: '모델', value: 'APC SRT', helpText: 'UPS 모델명', displayOrder: 2 },
                    { label: '설치일', value: '2021-11-01', helpText: '설치 날짜', displayOrder: 3 },
                    { label: '운전모드', value: 'Battery', helpText: '현재 운전 모드', displayOrder: 4 }
                ]
            }
        };

        // metricLatest 응답 (실시간 측정값 - raw int, scale 0.1 적용 필요)
        const mockMetricData = {
            normal: [
                { metricCode: 'UPS.INPUT_V_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2200 },
                { metricCode: 'UPS.INPUT_V_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2210 },
                { metricCode: 'UPS.INPUT_V_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2195 },
                { metricCode: 'UPS.INPUT_F_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.INPUT_F_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.INPUT_F_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.INPUT_A_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 150 },
                { metricCode: 'UPS.INPUT_A_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 148 },
                { metricCode: 'UPS.INPUT_A_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 152 },
                { metricCode: 'UPS.OUTPUT_V_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2200 },
                { metricCode: 'UPS.OUTPUT_V_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2200 },
                { metricCode: 'UPS.OUTPUT_V_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2200 },
                { metricCode: 'UPS.OUTPUT_F_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.OUTPUT_F_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.OUTPUT_F_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.OUTPUT_A_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 145 },
                { metricCode: 'UPS.OUTPUT_A_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 143 },
                { metricCode: 'UPS.OUTPUT_A_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 147 },
                { metricCode: 'UPS.BATT_V', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 5400 },
                { metricCode: 'UPS.BATT_A', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 20 },
                { metricCode: 'UPS.INPUT_BAD_STATE', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.BATT_CHARGING', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 1 },
                { metricCode: 'UPS.OUTPUT_ON_BATTERY', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.INVERTER_OFF', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.ON_BYPASS', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.BATT_FAULT', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.OUTPUT_OVERLOAD', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 }
            ],
            warning: [
                { metricCode: 'UPS.INPUT_V_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2150 },
                { metricCode: 'UPS.INPUT_V_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2080 },
                { metricCode: 'UPS.INPUT_V_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2170 },
                { metricCode: 'UPS.INPUT_F_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 598 },
                { metricCode: 'UPS.INPUT_F_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 595 },
                { metricCode: 'UPS.INPUT_F_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 599 },
                { metricCode: 'UPS.INPUT_A_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 180 },
                { metricCode: 'UPS.INPUT_A_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 185 },
                { metricCode: 'UPS.INPUT_A_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 178 },
                { metricCode: 'UPS.OUTPUT_V_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2190 },
                { metricCode: 'UPS.OUTPUT_V_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2185 },
                { metricCode: 'UPS.OUTPUT_V_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2195 },
                { metricCode: 'UPS.OUTPUT_F_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.OUTPUT_F_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.OUTPUT_F_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 600 },
                { metricCode: 'UPS.OUTPUT_A_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 175 },
                { metricCode: 'UPS.OUTPUT_A_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 180 },
                { metricCode: 'UPS.OUTPUT_A_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 173 },
                { metricCode: 'UPS.BATT_V', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 5100 },
                { metricCode: 'UPS.BATT_A', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 35 },
                { metricCode: 'UPS.INPUT_BAD_STATE', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 1 },
                { metricCode: 'UPS.BATT_CHARGING', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 1 },
                { metricCode: 'UPS.OUTPUT_ON_BATTERY', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.INVERTER_OFF', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.ON_BYPASS', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.BATT_FAULT', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.OUTPUT_OVERLOAD', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 }
            ],
            critical: [
                { metricCode: 'UPS.INPUT_V_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.INPUT_V_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.INPUT_V_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.INPUT_F_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.INPUT_F_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.INPUT_F_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.INPUT_A_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.INPUT_A_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.INPUT_A_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 0 },
                { metricCode: 'UPS.OUTPUT_V_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2180 },
                { metricCode: 'UPS.OUTPUT_V_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2175 },
                { metricCode: 'UPS.OUTPUT_V_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 2170 },
                { metricCode: 'UPS.OUTPUT_F_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 599 },
                { metricCode: 'UPS.OUTPUT_F_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 599 },
                { metricCode: 'UPS.OUTPUT_F_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 599 },
                { metricCode: 'UPS.OUTPUT_A_1', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 200 },
                { metricCode: 'UPS.OUTPUT_A_2', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 205 },
                { metricCode: 'UPS.OUTPUT_A_3', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 198 },
                { metricCode: 'UPS.BATT_V', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 3200 },
                { metricCode: 'UPS.BATT_A', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 85 },
                { metricCode: 'UPS.INPUT_BAD_STATE', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 1 },
                { metricCode: 'UPS.BATT_CHARGING', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.OUTPUT_ON_BATTERY', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 1 },
                { metricCode: 'UPS.INVERTER_OFF', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.ON_BYPASS', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 0 },
                { metricCode: 'UPS.BATT_FAULT', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 1 },
                { metricCode: 'UPS.OUTPUT_OVERLOAD', eventedAt: new Date().toISOString(), valueType: 'BOOL', valueNumber: 1 }
            ]
        };

        function generateHistoryData() {
            const timestamps = [];
            const load = [];
            const battery = [];
            const now = new Date();

            for (let i = 23; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 3600000);
                timestamps.push(time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }));
                const baseLoad = 45 + Math.sin(i / 4) * 15;
                load.push(Math.round((baseLoad + (Math.random() - 0.5) * 10) * 10) / 10);
                battery.push(Math.round((95 + (Math.random() - 0.5) * 10) * 10) / 10);
            }

            return {
                timestamps,
                values: { load, battery },
                fields: [
                    { key: 'load', label: 'Load', unit: '%' },
                    { key: 'battery', label: 'Battery', unit: '%' }
                ]
            };
        }

        function getMockData(datasetName) {
            switch (datasetName) {
                case 'assetDetailUnified': return mockUPSData[currentStatus];
                case 'metricLatest': return mockMetricData[currentStatus];
                case 'upsHistory': return generateHistoryData();
                default: return {};
            }
        }

        // Mock PopupMixin
        const PopupMixin = {
            applyShadowPopupMixin: (ctx, config) => {
                let shadowRoot = null;
                let _chart = null;

                ctx.showPopup = () => {
                    const host = ctx.page.element;
                    if (!host.shadowRoot) {
                        shadowRoot = host.attachShadow({ mode: 'open' });
                    } else {
                        shadowRoot = host.shadowRoot;
                        shadowRoot.innerHTML = '';
                    }

                    const style = document.createElement('style');
                    style.textContent = config.getStyles();
                    shadowRoot.appendChild(style);

                    const content = document.createElement('div');
                    content.innerHTML = config.getHTML();
                    shadowRoot.appendChild(content);

                    ctx._shadowRoot = shadowRoot;
                    config.onCreated?.();
                    console.log('[PopupMixin] Popup shown');
                };

                ctx.hidePopup = () => {
                    if (ctx._shadowRoot) {
                        ctx._shadowRoot.innerHTML = '';
                        console.log('[PopupMixin] Popup hidden');
                    }
                };

                ctx.destroyPopup = () => {
                    if (_chart) { _chart.dispose(); _chart = null; }
                    if (ctx._shadowRoot) {
                        ctx._shadowRoot.innerHTML = '';
                        ctx._shadowRoot = null;
                    }
                    console.log('[PopupMixin] Popup destroyed');
                };

                ctx.popupQuery = (sel) => ctx._shadowRoot?.querySelector(sel);
                ctx.popupQueryAll = (sel) => ctx._shadowRoot?.querySelectorAll(sel) || [];
                ctx.bindPopupEvents = (events) => {
                    Object.entries(events).forEach(([eventType, handlers]) => {
                        Object.entries(handlers).forEach(([selector, handler]) => {
                            ctx.popupQueryAll(selector).forEach(el => el.addEventListener(eventType, handler));
                        });
                    });
                };

                ctx._getChartRef = () => _chart;
                ctx._setChartRef = (c) => { _chart = c; };
            },

            applyEChartsMixin: (ctx) => {
                ctx.createChart = (selector) => {
                    const container = ctx.popupQuery(selector);
                    if (container) {
                        const chart = echarts.init(container);
                        ctx._setChartRef(chart);
                        console.log('[EChartsMixin] Chart created');
                    }
                };

                ctx.updateChart = (selector, option) => {
                    let chart = ctx._getChartRef();
                    if (!chart) {
                        const container = ctx.popupQuery(selector);
                        if (container) {
                            chart = echarts.init(container);
                            ctx._setChartRef(chart);
                        }
                    }
                    if (chart) {
                        chart.setOption(option);
                        console.log('[EChartsMixin] Chart updated');
                    }
                };
            }
        };

        // ======================
        // TEMPLATE HELPER
        // ======================
        function extractTemplate(htmlCode, templateId) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlCode, 'text/html');
            const template = doc.querySelector(`template#${templateId}`);
            return template?.innerHTML || '';
        }

        // ======================
        // COMPONENT INSTANCE
        // ======================
        let instance = null;

        function createInstance() {
            if (instance) { onInstanceUnLoad.call(instance); }

            instance = {
                id: 'preview-ups',
                page: { element: document.getElementById('popup-host') },
                properties: { publishCode: { htmlCode, cssCode } },
                setter: { assetInfo: { assetKey: 'mock-ups-001' } }
            };

            initComponent.call(instance);
            updateInstanceInfo();
        }

        function updateInstanceInfo() {
            const info = document.getElementById('instance-info');
            info.textContent = instance ? `Instance: ${instance.id}` : 'Instance: not created';
        }

        // ======================
        // COMPONENT LIFECYCLE
        // ======================

        function statusTypeToLabel(statusType) {
            const labels = { ACTIVE: 'Normal', WARNING: 'Warning', CRITICAL: 'Critical', INACTIVE: 'Inactive', MAINTENANCE: 'Maintenance' };
            return labels[statusType] || statusType;
        }

        function statusTypeToDataAttr(statusType) {
            const map = { ACTIVE: 'normal', WARNING: 'warning', CRITICAL: 'critical', INACTIVE: 'inactive', MAINTENANCE: 'maintenance' };
            return map[statusType] || 'normal';
        }

        function formatTimestamp(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch { return ''; }
        }

        const BASE_URL = 'http://10.23.128.125:4004';

        function initComponent() {
            const { bind3DEvents, fetchData } = Wkit;
            const { applyShadowPopupMixin, applyEChartsMixin } = PopupMixin;

            this._defaultAssetKey = this.setter?.assetInfo?.assetKey || this.id;

            // 데이터셋 정의
            this.datasetInfo = [
                { datasetName: 'assetDetailUnified', render: ['renderAssetInfo', 'renderProperties'] },
                { datasetName: 'metricLatest', render: ['renderMetrics'] }
            ];

            this.baseInfoConfig = [
                { key: 'name', selector: '.ups-name' },
                { key: 'locationLabel', selector: '.ups-zone' },
                { key: 'statusType', selector: '.ups-status', transform: statusTypeToLabel },
                { key: 'statusType', selector: '.ups-status', dataAttr: 'status', transform: statusTypeToDataAttr }
            ];

            this.metricsContainerSelector = '.metrics-container';
            this.propertiesContainerSelector = '.properties-container';
            this.propertiesSectionSelector = '.properties-section';
            this.timestampSelector = '.section-timestamp';
            this.metricConfig = METRIC_CONFIG;

            // Section Titles
            this.sectionTitles = {
                '.metrics-section .section-title': '실시간 측정값',
                '.properties-section .section-title': '속성 정보',
                '.chart-section .section-title': '히스토리',
            };

            this.formatTimestamp = formatTimestamp.bind(this);

            this.renderAssetInfo = renderAssetInfo.bind(this);
            this.renderProperties = renderProperties.bind(this);
            this.renderMetrics = renderMetrics.bind(this);
            this.renderError = renderError.bind(this);

            // Refresh Config
            this.refreshInterval = 5000; // 5초
            this._refreshIntervalId = null;

            this.showDetail = showDetail.bind(this);
            this.hideDetail = hideDetail.bind(this);
            this.refreshMetrics = refreshMetricsOnly.bind(this);
            this.stopRefresh = stopRefresh.bind(this);

            // chartConfig: 차트 렌더링 설정
            this.chartConfig = {
                xKey: 'timestamps',
                styleMap: {
                    load: { label: '부하율', unit: '%', color: '#3b82f6', smooth: true, areaStyle: true },
                    battery: { label: '배터리', unit: '%', color: '#22c55e', smooth: true }
                },
                optionBuilder: getMultiLineChartOption
            };

            this.renderChart = renderChart.bind(this, this.chartConfig);

            this.customEvents = { click: '@assetClicked' };
            bind3DEvents(this, this.customEvents);

            this.templateConfig = { popup: 'popup-ups' };
            this.popupCreatedConfig = {
                chartSelector: '.chart-container',
                events: { click: { '.close-btn': () => this.hideDetail() } }
            };

            const { htmlCode, cssCode } = this.properties.publishCode || {};
            const ctx = this;
            this.getPopupHTML = () => extractTemplate(htmlCode || '', ctx.templateConfig.popup);
            this.getPopupStyles = () => cssCode || '';
            this.onPopupCreated = function() {
                applySectionTitles.call(ctx);
                const { chartSelector, events } = ctx.popupCreatedConfig;
                if (chartSelector) ctx.createChart(chartSelector);
                if (events) ctx.bindPopupEvents(events);
            };

            applyShadowPopupMixin(this, {
                getHTML: this.getPopupHTML,
                getStyles: this.getPopupStyles,
                onCreated: this.onPopupCreated
            });

            applyEChartsMixin(this);

            console.log('[UPS] Registered:', this._defaultAssetKey);
        }

        function renderAssetInfo({ response }) {
            const { data } = response;
            if (!data || !data.asset) {
                renderError.call(this, '자산 데이터가 없습니다.');
                return;
            }

            const asset = data.asset;

            fx.go(
                this.baseInfoConfig,
                fx.each(({ key, selector, dataAttr, transform }) => {
                    const el = this.popupQuery(selector);
                    if (!el) return;
                    let value = asset[key];
                    if (transform) value = transform(value);
                    if (dataAttr) {
                        el.dataset[dataAttr] = value;
                    } else {
                        el.textContent = value;
                    }
                })
            );
        }

        function renderMetrics({ response }) {
            const { data } = response;
            const container = this.popupQuery(this.metricsContainerSelector);
            const timestampEl = this.popupQuery(this.timestampSelector);

            if (!container) return;

            if (!data || !Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<div class="empty-state">측정 데이터가 없습니다</div>';
                return;
            }

            if (timestampEl && data[0]?.eventedAt) {
                timestampEl.textContent = this.formatTimestamp(data[0].eventedAt);
            }

            container.innerHTML = data
                .map((metric) => {
                    const config = this.metricConfig[metric.metricCode];
                    if (!config) return '';

                    // BOOL type
                    if (config.valueType === 'BOOL') {
                        const isOn = metric.valueNumber === 1;
                        const boolClass = isOn ? 'bool-on' : 'bool-off';
                        const boolText = isOn ? 'ON' : 'OFF';
                        return `
                            <div class="metric-card metric-bool ${boolClass}">
                                <div class="metric-label">${config.label}</div>
                                <div class="metric-value-bool">${boolText}</div>
                            </div>
                        `;
                    }

                    // NUMBER type
                    const value = metric.valueNumber;
                    const displayValue = config.scale ? (value * config.scale).toFixed(1) : value;

                    return `
                        <div class="metric-card">
                            <div class="metric-label">${config.label}</div>
                            <div class="metric-value">${displayValue}<span class="metric-unit">${config.unit}</span></div>
                        </div>
                    `;
                })
                .join('');
        }

        function renderProperties({ response }) {
            const { data } = response;
            const container = this.popupQuery(this.propertiesContainerSelector);

            if (!container) return;

            // properties가 없거나 빈 배열인 경우 empty-state 표시
            if (!data?.properties || data.properties.length === 0) {
                container.innerHTML = '<div class="empty-state">속성 정보가 없습니다</div>';
                return;
            }

            const sortedProperties = [...data.properties].sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));

            container.innerHTML = sortedProperties
                .map(({ label, value, helpText }) => {
                    return `
                        <div class="property-card" title="${helpText || ''}">
                            <div class="property-label">${label}</div>
                            <div class="property-value">${value ?? '-'}</div>
                        </div>
                    `;
                })
                .join('');
        }

        function renderError(message) {
            const nameEl = this.popupQuery('.ups-name');
            const zoneEl = this.popupQuery('.ups-zone');
            const statusEl = this.popupQuery('.ups-status');

            if (nameEl) nameEl.textContent = '데이터 없음';
            if (zoneEl) zoneEl.textContent = message;
            if (statusEl) {
                statusEl.textContent = 'Error';
                statusEl.dataset.status = 'critical';
            }

            const metricsContainer = this.popupQuery(this.metricsContainerSelector);
            if (metricsContainer) {
                metricsContainer.innerHTML = `<div class="error-state">${message}</div>`;
            }

            console.warn('[UPS] renderError:', message);
        }

        function renderChart(config, { response }) {
            const { data } = response;
            if (!data) return;
            const { optionBuilder, ...chartConfig } = config;
            const option = optionBuilder(chartConfig, data);
            this.updateChart('.chart-container', option);
        }

        function showDetail() {
            this.showPopup();
            fx.go(
                this.datasetInfo,
                fx.each(({ datasetName, render }) =>
                    fx.go(
                        Wkit.fetchData(this.page, datasetName, { baseUrl: BASE_URL, assetKey: this._defaultAssetKey, locale: 'ko' }),
                        (response) => {
                            if (!response || !response.response) {
                                this.renderError('데이터를 불러올 수 없습니다.');
                                return;
                            }
                            const data = response.response.data;
                            if (data === null || data === undefined) {
                                this.renderError('자산 정보가 존재하지 않습니다.');
                                return;
                            }
                            fx.each((fn) => this[fn](response), render);
                        }
                    )
                )
            ).catch(e => {
                console.error('[UPS]', e);
                this.renderError('데이터 로드 중 오류가 발생했습니다.');
            });

            // 5초 주기로 메트릭 갱신 시작
            this.stopRefresh();
            this._refreshIntervalId = setInterval(() => this.refreshMetrics(), this.refreshInterval);
            console.log('[UPS] Metric refresh started (5s interval)');
        }

        function hideDetail() {
            this.stopRefresh();
            this.hidePopup();
        }

        function refreshMetricsOnly() {
            fx.go(
                Wkit.fetchData(this.page, 'metricLatest', { baseUrl: BASE_URL, assetKey: this._defaultAssetKey }),
                (response) => {
                    if (!response || !response.response) return;
                    const data = response.response.data;
                    if (data === null || data === undefined) return;
                    this.renderMetrics(response);
                }
            ).catch(e => {
                console.warn('[UPS] Metric refresh failed:', e);
            });
        }

        function stopRefresh() {
            if (this._refreshIntervalId) {
                clearInterval(this._refreshIntervalId);
                this._refreshIntervalId = null;
                console.log('[UPS] Metric refresh stopped');
            }
        }

        function getMultiLineChartOption(config, data) {
            const { xKey, styleMap } = config;

            const seriesData = Object.entries(styleMap).map(([key, style]) => ({
                key,
                name: style.label,
                unit: style.unit,
                color: style.color,
                smooth: style.smooth,
                areaStyle: style.areaStyle
            }));

            return {
                grid: { left: 45, right: 16, top: 30, bottom: 24 },
                legend: {
                    data: seriesData.map(s => s.name),
                    top: 0,
                    textStyle: { color: '#8892a0', fontSize: 11 }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: '#1a1f2e',
                    borderColor: '#2a3142',
                    textStyle: { color: '#e0e6ed', fontSize: 12 }
                },
                xAxis: {
                    type: 'category',
                    data: data[xKey],
                    axisLine: { lineStyle: { color: '#333' } },
                    axisLabel: { color: '#888', fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLine: { show: false },
                    axisLabel: { color: '#888', fontSize: 10, formatter: '{value}%' },
                    splitLine: { lineStyle: { color: '#333' } }
                },
                series: seriesData.map(({ key, name, color, smooth, areaStyle }) => ({
                    name,
                    type: 'line',
                    data: data[key],
                    smooth,
                    symbol: 'none',
                    lineStyle: { color, width: 2 },
                    areaStyle: areaStyle ? {
                        color: {
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: hexToRgba(color, 0.3) },
                                { offset: 1, color: hexToRgba(color, 0) }
                            ]
                        }
                    } : null
                }))
            };
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function applySectionTitles() {
            if (!this.sectionTitles) return;
            Object.entries(this.sectionTitles).forEach(([selector, title]) => {
                const el = this.popupQuery(selector);
                if (el) el.textContent = title;
            });
        }

        function onInstanceUnLoad() {
            this.stopRefresh();
            this.destroyPopup();
            console.log('[UPS] Destroyed:', this.id);
        }

        // ======================
        // PREVIEW CONTROLS
        // ======================

        function showNormal() {
            currentStatus = 'normal';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function showWarning() {
            currentStatus = 'warning';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function showCritical() {
            currentStatus = 'critical';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function destroyInstance() {
            if (instance) {
                onInstanceUnLoad.call(instance);
                instance = null;
                updateInstanceInfo();
            }
        }
    </script>
</body>
</html>
